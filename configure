#!/bin/bash
# Script to edit configuration settings
# $Id: configure,v 1.13 2001/09/23 21:20:00 mohni Exp $

DIALOG=${DIALOG=dialog}
tempfile=`tempfile 2>/dev/null` || tempfile=/tmp/test$$
trap "rm -f $tempfile" 0 1 2 5 15

# Strings
ADMINEMAIL=phpbt@`hostname -d`
INSTALLPATH=`pwd`
INSTALLURL=http://`hostname -f`/phpbt
PHPLIBPATH=''
JPGRAPH_PATH=''
ATTACHMENT_PATH='attachments'
DB_HOST='localhost'
DB_USER='root'
DB_PASS=''
DB_TBL_PREFIX=''

# Booleans
ENCRYPTPASS=1
USE_JPGRAPH=0
MASK_EMAIL=0
HIDE_EMAIL=1
SEV_COLOR=1
EMAIL_IS_LOGIN=1

administrivia() {
	$DIALOG --backtitle "phpBT Configuration" \
		--title "Admin Email (1 of 5)" \
		--inputbox "Enter the email address of the administrator of this installation. \
			All emails from phpBugTracker will come from this address" 0 0 $ADMINEMAIL \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	ADMINEMAIL=`<$tempfile`

	$DIALOG --backtitle "phpBT Configuration" \
		--title "Installation Path (2 of 5)" \
		--inputbox "Enter the directory where the files will be stored.\n\n\
NOTE -- This does not move the files to the directory you specify; it only changes include.php.  \
If you specify a directory other than the current one, you'll need to move the files there yourself!\n\n" 0 0 $INSTALLPATH \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	INSTALLPATH=`<$tempfile`

	$DIALOG --backtitle "phpBT Configuration" \
		--title "Attachment Path (3 of 5)" \
		--inputbox "Enter the sub-directory where the attachments will be stored.\n\n\
NOTE -- This does not create the directory you specify; it only changes include.php.  \
If you don't use the default directory, you must make sure the permissions on
that directory allow the web server to create and read files in it!\n\n" 0 0 $ATTACHMENT_PATH \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	ATTACHMENT_PATH=`<$tempfile`

	$DIALOG --backtitle "phpBT Configuration" \
		--title "Installation URL (4 of 5)" \
		--inputbox "Enter the web site where phpBugTracker will be accessable" 0 0 $INSTALLURL \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	INSTALLURL=`<$tempfile`

	$DIALOG --backtitle "phpBT Configuration" \
		--title "PHPlib Path (5 of 5)" \
		--inputbox "If PHPlib is not in PHP's include path, specify the location of PHPlib." 0 0 $PHPLIBPATH \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	
	PHPLIBPATH=`<$tempfile`
}

database() {
	$DIALOG --backtitle "phpBT Configuration" \
		--title "Database Server Software (1 of 5)" \
		--radiolist "Enter the type database server" 0 0 3 \
			mysql MySQL on \
			pgsql PostgreSQL off \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	DB_TYPE=`<$tempfile`

	$DIALOG --backtitle "phpBT Configuration" \
		--title "Database Host (2 of 5)" \
		--inputbox "Enter the hostname of the server hosting the database server" 0 0 $DB_HOST \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	DB_HOST=`<$tempfile`

	$DIALOG --backtitle "phpBT Configuration" \
		--title "Database User (3 of 5)" \
		--inputbox "Enter the username to use for connecting to the database" 0 0 $DB_USER \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	DB_USER=`<$tempfile`

	$DIALOG --backtitle "phpBT Configuration" \
		--title "Database Password (4 of 5)" \
		--inputbox "Enter the password to use when connecting to the database" 0 0 $DB_PASS \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	DB_PASS=`<$tempfile`

	$DIALOG --backtitle "phpBT Configuration" \
		--title "Database Table Prefix (5 of 5)" \
		--inputbox "Enter the prefix to be used in creating table names (like phpbt_)" 0 0 $DB_TBL_PREFIX \
		2> $tempfile
	if [ $? -gt 0 ]; then
		return
	fi
	DB_TBL_PREFIX=`<$tempfile`
}

change_features() {
	if [ $ENCRYPTPASS -eq 1 ]; then
		OLD_ENCRYPTPASS=on
	else 
		OLD_ENCRYPTPASS=off
	fi
	if [ $USE_JPGRAPH -eq 1 ]; then
		OLD_USE_JPGRAPH=on
	else
		OLD_USE_JPGRAPH=off
	fi
	if [ $MASK_EMAIL -eq 1 ]; then
		OLD_MASK_EMAIL=on
	else 
		OLD_MASK_EMAIL=off
	fi
	if [ $HIDE_EMAIL -eq 1 ]; then
		OLD_HIDE_EMAIL=on
	else
		OLD_HIDE_EMAIL=off
	fi
	if [ $SEV_COLOR -eq 1 ]; then
		OLD_SEV_COLOR=on
	else
		OLD_SEV_COLOR=off
	fi
	if [ $EMAIL_IS_LOGIN -eq 1 ]; then
		OLD_EMAIL_IS_LOGIN=on
	else
		OLD_EMAIL_IS_LOGIN=off
	fi
	
	NEW_ENCRYPTPASS=0
	NEW_USE_JPGRAPH=0
	NEW_MASK_EMAIL=0
	NEW_HIDE_EMAIL=0
	NEW_SEV_COLOR=0
	NEW_EMAIL_IS_LOGIN=0

	$DIALOG --backtitle "phpBT Configuration" \
		--title "Optional Features" \
		--separate-output \
  	--checklist "Choose the features below you would like to enable" 18 78 8 \
    	"ENCRYPTPASS" "Store passwords encrypted in the database" $OLD_ENCRYPTPASS \
    	"USE_JPGRAPH" "Use the JP Graph class for charting some reports" $OLD_USE_JPGRAPH \
    	"MASK_EMAIL" "Replace @ with at and . with dot when showing emails" $OLD_MASK_EMAIL \
    	"HIDE_EMAIL" "Completely hide emails when not logged in" $OLD_HIDE_EMAIL \
    	"SEV_COLOR" "Color rows in bug list according to severity" $OLD_SEV_COLOR \
    	"EMAIL_IS_LOGIN" "Use the email address as user login" $OLD_EMAIL_IS_LOGIN \
  	2> $tempfile

	retval=$?

	choice=`<$tempfile`
	if [ $retval -eq 0 ]; then
    for selected in $choice
		do
			case $selected in
				ENCRYPTPASS)
					NEW_ENCRYPTPASS=1;;
				USE_JPGRAPH)
					NEW_USE_JPGRAPH=1;;
				MASK_EMAIL)
					NEW_MASK_EMAIL=1;;
				HIDE_EMAIL)
					NEW_HIDE_EMAIL=1;;
				SEV_COLOR)
					NEW_SEV_COLOR=1;;
				EMAIL_IS_LOGIN)
					NEW_EMAIL_IS_LOGIN=1;;
			esac
		done

		ENCRYPTPASS=${NEW_ENCRYPTPASS:-0}
		USE_JPGRAPH=${NEW_USE_JPGRAPH:-0}
		MASK_EMAIL=${NEW_MASK_EMAIL:-0}
		HIDE_EMAIL=${NEW_HIDE_EMAIL:-0}
		SEV_COLOR=${NEW_SEV_COLOR:-0}
		EMAIL_IS_LOGIN=${NEW_EMAIL_IS_LOGIN:-0}
	fi
	
	if [ $USE_JPGRAPH -eq 1 ]; then
		$DIALOG --backtitle "phpBT Configuration" \
			--title "JPGraph Path" \
			--inputbox "If JPGraph is not in PHP's include path, specify the location of JPGraph." 0 0 $JPGRAPH_PATH \
			2> $tempfile
		if [ $? -eq 0 ]; then
			JPGRAPH_PATH=`<$tempfile`
		fi
	fi
		
}

show_menu() {
	$DIALOG --clear --backtitle "phpBT Configuration" \
		--title "Configuration Menu" \
  	--menu "Choose from the options below to configure your phpBugTracker installation." 15 68 4 \
			"Administrivia" "Parameters that must be configured" \
			"Database" "Database connection settings" \
  		"Features"  "Optional features" \
			"Save" "Save configuration changes" \
		2> $tempfile

	retval=$?

	choice=`<$tempfile`
	if [ $retval -eq 0 ]; then
    case $choice in
			Administrivia)
				administrivia
				;;
			Database)
				database
				;;
			Features)
				change_features
				;;
			Save)
				# Change the constants in config.php, saving a backup
				mv config.php config.php.bak
				echo "/ENCRYPTPASS/s/[[:digit:]]/$ENCRYPTPASS/" > $tempfile
				echo "/USE_JPGRAPH/s/[[:digit:]]/$USE_JPGRAPH/" >> $tempfile
				echo "/MASK_EMAIL/s/[[:digit:]]/$MASK_EMAIL/" >> $tempfile
				echo "/HIDE_EMAIL/s/[[:digit:]]/$HIDE_EMAIL/" >> $tempfile
				echo "/USE_SEVERITY_COLOR/s/[[:digit:]]/$SEV_COLOR/" >> $tempfile
				echo "/EMAIL_IS_LOGIN/s/[[:digit:]]/$EMAIL_IS_LOGIN/" >> $tempfile
				echo "/ADMINEMAIL/s|, '.*'|, '$ADMINEMAIL'|" >> $tempfile
				echo "/INSTALLPATH/s|, '.*'|, '$INSTALLPATH'|" >> $tempfile
				echo "/ATTACHMENT_PATH/s|, '.*'|, '$ATTACHMENT_PATH'|" >> $tempfile
				echo "/INSTALLURL/s|, '.*'|, '$INSTALLURL'|" >> $tempfile
				echo "/PHPLIBPATH/s|, '.*'|, '$PHPLIBPATH'|" >> $tempfile
				echo "/JPGRAPH_PATH/s|, '.*'|, '$JPGRAPH_PATH'|" >> $tempfile
				echo "/DB_TYPE/s|, '.*'|, '$DB_TYPE'|" >> $tempfile
				echo "/DB_HOST/s|, '.*'|, '$DB_HOST'|" >> $tempfile
				echo "/DB_USER/s|, '.*'|, '$DB_USER'|" >> $tempfile
				echo "/DB_PASSWORD/s|, '.*'|, '$DB_PASS'|" >> $tempfile
				echo "/TBL_PREFIX/s|, '.*'|, '$DB_TBL_PREFIX'|" >> $tempfile
				sed -f $tempfile config.php.bak > config.php
				
				# run the configure_db script
				./configure_db -t $DB_TYPE -p $DB_TBL_PREFIX 
				
				$DIALOG --backtitle "phpBT Configuration" \
					--msgbox "Your changes have been saved, and your database creation file is createdb.sql" 0 0
				exit
				;;
		esac
	else
  	$DIALOG --backtitle "phpBT Configuration" \
			--infobox "Quitting without saving changes" 5 36
		return 254
	fi
}

while [ $? -ne 254 ]; do
	show_menu
done
