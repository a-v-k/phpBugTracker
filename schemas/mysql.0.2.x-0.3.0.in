#
# -- Conversion from 0.2.x to 0.3.0 --
#

INSERT INTO TBL_ATTACHMENT SELECT * FROM Attachment;
INSERT INTO TBL_AUTH_USER SELECT UserID, Email, FirstName, LastName, Email, Password, if (UserLevel > 0, 1, 0), '', 0, CreatedDate, 0, CreatedDate FROM User;
INSERT INTO TBL_BUG SELECT *, 0 FROM Bug;
INSERT INTO TBL_BUG_HISTORY SELECT * FROM BugHistory;
INSERT INTO TBL_COMMENT SELECT * FROM Comment;
INSERT INTO TBL_COMPONENT SELECT * FROM Component;
INSERT INTO TBL_OS SELECT * FROM OS;
INSERT INTO TBL_PROJECT SELECT *, CreatedBy, CreatedDate FROM Project;
INSERT INTO TBL_RESOLUTION SELECT * FROM Resolution;
INSERT INTO TBL_SAVED_QUERY SELECT * FROM SavedQuery;
INSERT INTO TBL_SEVERITY SELECT *, '' FROM Severity;
UPDATE TBL_SEVERITY SET severity_color = '#dadada' WHERE severity_id = '1';
UPDATE TBL_SEVERITY SET severity_color = '#dad0d0' WHERE severity_id = '2';
UPDATE TBL_SEVERITY SET severity_color = '#dacaca' WHERE severity_id = '3';
UPDATE TBL_SEVERITY SET severity_color = '#dac0c0' WHERE severity_id = '4';
UPDATE TBL_SEVERITY SET severity_color = '#dababa' WHERE severity_id = '5';
UPDATE TBL_SEVERITY SET severity_color = '#dab0b0' WHERE severity_id = '6';
UPDATE TBL_SEVERITY SET severity_color = '#daaaaa' WHERE severity_id = '7';
INSERT INTO TBL_STATUS SELECT * FROM Status;
INSERT INTO TBL_VERSION SELECT *, CreatedBy, CreatedDate FROM Version;

# Start off with three user levels...
INSERT INTO TBL_AUTH_GROUP (group_id, group_name) VALUES (1, 'Admin');
INSERT INTO TBL_AUTH_GROUP (group_id, group_name) VALUES (2, 'User');
INSERT INTO TBL_AUTH_GROUP (group_id, group_name) VALUES (3, 'Developer');

# ... and only two permissions 
INSERT INTO TBL_AUTH_PERM (perm_id, perm_name) VALUES (1, 'Admin');
INSERT INTO TBL_AUTH_PERM (perm_id, perm_name) VALUES (2, 'Editbug');

# Admins can do all the admin stuff and users can edit bugs
INSERT INTO TBL_GROUP_PERM (group_id, perm_id) VALUES (1, 1);
INSERT INTO TBL_GROUP_PERM (group_id, perm_id) VALUES (2, 2);

# Move users into the new tables
INSERT INTO TBL_USER_GROUP (user_id, group_id) SELECT UserID, group_id FROM User, TBL_AUTH_GROUP where UserLevel = 15 and group_name = 'Admin';
INSERT INTO TBL_USER_GROUP (user_id, group_id) SELECT UserID, group_id FROM User, TBL_AUTH_GROUP where UserLevel = 3 and group_name = 'Developer';
INSERT INTO TBL_USER_GROUP (user_id, group_id) SELECT UserID, 2 FROM User where UserLevel > 0;

